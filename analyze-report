#!/usr/bin/env python3
"""
è´¢åŠ¡åˆ†æå¿«æ·å‘½ä»¤
ç”¨æ³•: analyze-report <pdf_path> [--price <è‚¡ä»·>]
"""

import sys
import argparse
from pathlib import Path

# æ·»åŠ æ¨¡å—è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent))

from financial_analyzer import (
    FinancialReportParser,
    FinancialIndicatorCalculator,
    FinancialAnalyzer,
    AnalysisReportGenerator
)


def main():
    parser = argparse.ArgumentParser(description='è´¢åŠ¡æŠ¥è¡¨æ™ºèƒ½åˆ†æå·¥å…·')
    parser.add_argument('pdf_path', help='PDFè´¢æŠ¥æ–‡ä»¶è·¯å¾„')
    parser.add_argument('--price', type=float, help='å½“å‰è‚¡ä»·ï¼ˆå¯é€‰ï¼‰')
    parser.add_argument('--investor-type', choices=['æ¿€è¿›å‹', 'ç¨³å¥å‹', 'ä¿å®ˆå‹'],
                        default='ç¨³å¥å‹', help='æŠ•èµ„è€…ç±»å‹')
    parser.add_argument('--output-dir', default='.', help='æŠ¥å‘Šè¾“å‡ºç›®å½•')

    args = parser.parse_args()

    print("ğŸ” å¼€å§‹åˆ†æè´¢åŠ¡æŠ¥è¡¨...")

    # 1. è§£æPDF
    print("\n[1/5] è§£æPDFè´¢æŠ¥")
    parser_obj = FinancialReportParser()
    statement = parser_obj.parse_pdf(args.pdf_path)

    # 2. è®¡ç®—æŒ‡æ ‡
    print("[2/5] è®¡ç®—è´¢åŠ¡æŒ‡æ ‡")
    calculator = FinancialIndicatorCalculator()
    indicators = calculator.calculate_all_indicators(
        balance_sheet=statement.balance_sheet,
        income_statement=statement.income_statement,
        cashflow_statement=statement.cashflow_statement,
        metadata=statement.metadata
    )
    summary = calculator.get_summary()

    # 3. ä¸“ä¸šåˆ†æ
    print("[3/5] è¿›è¡Œä¸“ä¸šåˆ†æ")
    analyzer = FinancialAnalyzer()
    analysis = analyzer.analyze_financial_health(
        company_name=statement.company_name,
        indicators=indicators,
        report_type=statement.report_type,
        report_period=statement.report_period
    )

    # 4. æŠ•èµ„å»ºè®®
    print("[4/5] ç”ŸæˆæŠ•èµ„å»ºè®®")
    recommendation = analyzer.generate_investment_recommendation(
        analysis=analysis,
        indicators=indicators,
        stock_price=args.price,
        target_investor_type=args.investor_type
    )

    # 5. ç”ŸæˆæŠ¥å‘Š
    print("[5/5] ç”Ÿæˆåˆ†ææŠ¥å‘Š")
    report_gen = AnalysisReportGenerator()

    md_path = f"{args.output_dir}/{statement.company_name}_{statement.report_period}_åˆ†ææŠ¥å‘Š.md"
    excel_path = f"{args.output_dir}/{statement.company_name}_{statement.report_period}_æ•°æ®.xlsx"

    report_gen.generate_markdown_report(
        company_name=statement.company_name,
        report_period=statement.report_period,
        report_type=statement.report_type,
        statement_data={
            'balance_sheet': statement.balance_sheet,
            'income_statement': statement.income_statement,
            'cashflow_statement': statement.cashflow_statement,
        },
        indicators=indicators,
        analysis=analysis,
        recommendation=recommendation,
        output_path=md_path
    )

    report_gen.generate_excel_report(
        company_name=statement.company_name,
        report_period=statement.report_period,
        statement_data={
            'balance_sheet': statement.balance_sheet,
            'income_statement': statement.income_statement,
            'cashflow_statement': statement.cashflow_statement,
        },
        indicators=indicators,
        output_path=excel_path
    )

    # è¾“å‡ºæ‘˜è¦
    print("\n" + "=" * 60)
    print(f"âœ… åˆ†æå®Œæˆï¼")
    print("=" * 60)
    print(f"\nğŸ“Š {statement.company_name} - {statement.report_type}")
    print(f"ğŸ“… æŠ¥å‘ŠæœŸ: {statement.report_period}")
    print(f"\nğŸ’¯ ç»¼åˆè¯„åˆ†: {summary.get('ç»¼åˆè¯„åˆ†', 'N/A')}/100")
    print(f"â­ ç»¼åˆè¯„çº§: {analysis['overall_rating']}")
    print(f"ğŸ“ˆ æŠ•èµ„è¯„çº§: {recommendation['rating']}")
    print(f"ğŸ’¡ æ“ä½œå»ºè®®: {recommendation['action']}")

    if args.price and recommendation.get('target_price'):
        upside = ((recommendation['target_price'] - args.price) / args.price) * 100
        print(f"\nğŸ’° å½“å‰ä»·æ ¼: {args.price:.2f} å…ƒ")
        print(f"ğŸ¯ ç›®æ ‡ä»·æ ¼: {recommendation['target_price']:.2f} å…ƒ")
        print(f"ğŸ“Š ä¸Šæ¶¨ç©ºé—´: {upside:+.2f}%")

    print(f"\nğŸ“„ æŠ¥å‘Šæ–‡ä»¶:")
    print(f"   - {md_path}")
    print(f"   - {excel_path}")
    print("\n" + "=" * 60)


if __name__ == '__main__':
    main()
